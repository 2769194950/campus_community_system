# 清理登录状态完整指南

## 为什么重启后还是已登录状态？

登录状态被保存在三个地方：
1. **浏览器 Local Storage** - 保存 token 和用户信息
2. **Redis 数据库** - 保存 LoginTicket（有效期通常是3600秒 = 1小时）
3. **Vuex Store** - 运行时状态（刷新页面时从 Local Storage 恢复）

---

## 方法1：完全清除登录状态（推荐测试用）

### 步骤1：清除浏览器存储

1. **打开浏览器开发者工具**（F12）

2. **切换到 Application 标签**（Chrome/Edge）或 Storage 标签（Firefox）

3. **清除 Local Storage**：
   - 左侧菜单：Local Storage → http://localhost:8081
   - 右键点击 → **Clear**
   - 或者删除 `user` 和 `token` 两个键

4. **清除 Cookies**（如果有）：
   - 左侧菜单：Cookies → http://localhost:8081
   - 删除所有 cookies

5. **刷新页面**（Ctrl+F5 强制刷新）

### 步骤2：（可选）清除 Redis 中的 LoginTicket

如果你想彻底清除后端的登录凭证：

**方法A：使用 Redis CLI**
```bash
# 连接到 Redis
redis-cli

# 查看所有登录凭证的 key
KEYS ticket:*

# 删除所有登录凭证
DEL ticket:abc-123-def-456  # 替换为实际的 ticket

# 或者删除所有
FLUSHDB
```

**方法B：重启 Redis 服务**
```bash
# Windows
net stop Redis
net start Redis

# 或者在服务管理器中重启 Redis
```

---

## 方法2：使用退出登录功能（正常用户流程）

这是用户正常使用的方式：

1. **点击右上角用户头像**
2. **点击"退出登录"**
3. **确认退出**

这会做以下事情：
- ✅ 调用后端 `/api/user/logout` API
- ✅ 清除浏览器 Local Storage
- ✅ 清除 Vuex Store 中的状态
- ✅ 跳转回首页

但是 **Redis 中的 LoginTicket 不会被立即删除**（这是正常的，只是标记为无效）

---

## 方法3：使用浏览器隐身模式测试

这是最简单的测试方式：

1. **打开浏览器隐身窗口**：
   - Chrome/Edge: `Ctrl+Shift+N`
   - Firefox: `Ctrl+Shift+P`

2. **访问** http://localhost:8081/

3. **进行测试**

**优点：**
- 不会保存任何登录状态
- 不影响正常浏览器窗口的数据
- 关闭窗口即清除所有数据

---

## 方法4：快速清除 - 使用浏览器控制台

如果你想快速清除登录状态，可以在浏览器控制台执行：

1. **打开浏览器控制台**（F12 → Console）

2. **执行以下代码**：
```javascript
// 清除 Local Storage
localStorage.removeItem('user');
localStorage.removeItem('token');

// 刷新页面
window.location.reload();
```

3. **或者一行搞定**：
```javascript
localStorage.clear(); location.reload();
```

---

## 如何验证登录状态已清除

### 检查清单：

**在浏览器中：**
- [ ] 打开开发者工具 → Application → Local Storage
- [ ] 确认 `user` 和 `token` 已被删除
- [ ] 页面右上角显示"登录"和"注册"按钮（而不是用户头像）

**在 IDEA 后端日志中：**
- [ ] 刷新页面后，查看日志
- [ ] 应该看到：
  ```
  >>> Interceptor: GET /api/xxx
  >>> Authorization header: null
  >>> Cookie ticket: null
  >>> No ticket found
  ```

---

## 完整的测试循环

### 测试场景1：测试登录和退出

```
1. 清除登录状态（使用上面任一方法）
   ↓
2. 访问 http://localhost:8081/
   ↓
3. 点击"登录"
   ↓
4. 输入用户名密码
   ↓
5. 观察 IDEA 日志和浏览器 Console
   ↓
6. 确认登录成功，显示头像
   ↓
7. 点击"退出登录"
   ↓
8. 确认退出成功，显示"登录"按钮
```

### 测试场景2：测试登录持久性

```
1. 登录成功
   ↓
2. 关闭浏览器
   ↓
3. 重新打开浏览器，访问 http://localhost:8081/
   ↓
4. 应该仍然显示已登录状态（这是正常的！）
   ↓
5. 观察 IDEA 日志：
   >>> Authorization header: abc-123-def-456
   >>> Found user: testuser001
```

### 测试场景3：测试 Token 过期

```
1. 登录成功
   ↓
2. 等待 1 小时（token 过期时间）
   ↓
3. 刷新页面或进行任何操作
   ↓
4. 应该自动退出登录
   ↓
5. IDEA 日志应该显示：
   >>> LoginTicket is invalid or expired
```

---

## 常见问题

### Q1: 为什么清除了浏览器存储还是显示已登录？

**可能原因：**
- 没有刷新页面（需要 Ctrl+F5 强制刷新）
- Vuex Store 中还有缓存
- 浏览器缓存问题

**解决方案：**
```javascript
// 在浏览器控制台执行
localStorage.clear();
sessionStorage.clear();
location.reload(true);  // 强制刷新
```

### Q2: 我想每次重启后端都清除所有登录状态

**解决方案：**
在后端启动时自动清除 Redis：

编辑 `application.properties`：
```properties
# 开发环境下，启动时清空 Redis（谨慎使用！）
spring.redis.flush-on-startup=true
```

或者在启动类中添加：
```java
@PostConstruct
public void clearRedis() {
    redisTemplate.getConnectionFactory().getConnection().flushDb();
    System.out.println(">>> Redis cleared on startup");
}
```

### Q3: 如何查看当前的 Token 是什么？

**在浏览器控制台执行：**
```javascript
console.log('Token:', localStorage.getItem('token'));
console.log('User:', JSON.parse(localStorage.getItem('user')));
```

**在 IDEA 后端日志中：**
- 每次请求都会打印 `>>> Authorization header: xxx-xxx-xxx`
- 这就是当前使用的 token

---

## 推荐的测试流程

### 开发阶段（频繁测试）：

1. **使用隐身模式** - 最方便，不影响正常状态
2. **或者使用控制台快速清除**：
   ```javascript
   localStorage.clear(); location.reload();
   ```

### 完整测试阶段：

1. **完全清除所有状态**（包括 Redis）
2. **按照测试步骤清单逐一测试**
3. **记录所有日志输出**

### 生产环境模拟：

1. **不清除任何状态**
2. **测试登录持久性**
3. **测试多设备登录**
4. **测试 Token 过期后的行为**

---

## 快速命令参考

### 浏览器控制台：
```javascript
// 查看登录状态
console.log('User:', localStorage.getItem('user'));
console.log('Token:', localStorage.getItem('token'));

// 清除登录状态
localStorage.removeItem('user');
localStorage.removeItem('token');
location.reload();

// 完全清除
localStorage.clear();
sessionStorage.clear();
location.reload(true);
```

### Redis CLI：
```bash
# 查看所有 ticket
KEYS ticket:*

# 查看特定 ticket
GET ticket:abc-123-def

# 删除所有 ticket
KEYS ticket:* | xargs redis-cli DEL

# 清空数据库
FLUSHDB
```

---

**现在你知道为什么重启后还是已登录状态了！这是正常的行为，因为登录状态被持久化保存了。** 🎉

如果你想测试"从零开始"的登录流程，使用**隐身模式**是最简单的方法！

