# 密保问题找回密码功能实现说明

## 📋 功能概述

实现了基于密保问题的密码找回功能，用户可以通过设置3个密保问题来找回密码，作为邮箱找回的补充方式。

## 🔧 实现内容

### 1. 数据库更新

**需要执行的 SQL 脚本：** `campus-community-system/docs/sql/add_security_questions.sql`

```sql
ALTER TABLE `user` 
ADD COLUMN `security_question_1` VARCHAR(200) NULL COMMENT '密保问题1' AFTER `introduction`,
ADD COLUMN `security_answer_1` VARCHAR(200) NULL COMMENT '密保答案1' AFTER `security_question_1`,
ADD COLUMN `security_question_2` VARCHAR(200) NULL COMMENT '密保问题2' AFTER `security_answer_1`,
ADD COLUMN `security_answer_2` VARCHAR(200) NULL COMMENT '密保答案2' AFTER `security_question_2`,
ADD COLUMN `security_question_3` VARCHAR(200) NULL COMMENT '密保问题3' AFTER `security_answer_2`,
ADD COLUMN `security_answer_3` VARCHAR(200) NULL COMMENT '密保答案3' AFTER `security_question_3`;
```

### 2. 后端实现

#### 修改的文件：
1. **User.java** - 添加密保问题字段
2. **UserMapper.java & UserMapper.xml** - 添加数据库操作方法
3. **UserService.java & UserServiceImpl.java** - 添加业务逻辑
   - `updateSecurityQuestions()` - 设置密保问题
   - `getSecurityQuestions()` - 获取用户的密保问题
   - `verifySecurityAnswers()` - 验证密保答案
   - `resetPasswordBySecurityQuestions()` - 通过密保问题重置密码
4. **UserController.java** - 添加 REST API 接口

#### 新增的 API 接口：

| 接口 | 方法 | 说明 | 需要登录 |
|------|------|------|----------|
| `/api/user/security-questions` | POST | 设置密保问题 | ✓ |
| `/api/user/security-questions?username=xxx` | GET | 获取用户的密保问题 | ✗ |
| `/api/user/reset-password-by-security` | POST | 通过密保问题重置密码 | ✗ |

### 3. 前端实现

#### 修改的文件：
1. **ProfileEdit.vue** - 在个人资料编辑页面添加密保问题设置区域
2. **ForgotPasswordModal.vue** - 修改为 Tab 切换形式，支持邮箱和密保问题两种找回方式

#### 功能特性：
- ✓ 在个人资料编辑页面设置3个密保问题及答案
- ✓ 忘记密码时可选择"邮箱找回"或"密保问题找回"
- ✓ 密保问题找回流程：输入用户名 → 获取密保问题 → 回答问题 → 设置新密码
- ✓ 密保答案加密存储（使用 MD5）
- ✓ 答案不区分大小写（统一转为小写后加密）

## 🧪 测试步骤

### 步骤 1：执行数据库更新

1. 打开 MySQL 客户端（Navicat、MySQL Workbench 等）
2. 选择 `campus_community` 数据库
3. 执行 `campus-community-system/docs/sql/add_security_questions.sql` 中的 SQL 语句

### 步骤 2：重启后端服务

1. 在 IDEA 中停止当前运行的后端服务
2. 重新运行 `CampusCommunitySystemApplication`

### 步骤 3：重启前端服务

```bash
cd frontend
npm run serve
```

### 步骤 4：测试密保问题设置

1. 登录系统
2. 点击右上角用户头像 → "个人资料" → "编辑个人资料"
3. 滚动到"密保问题设置"区域
4. 填写3个密保问题和答案（例如：）
   - 问题1：您母亲的姓名是？ 答案：张三
   - 问题2：您的出生地是？ 答案：北京
   - 问题3：您的第一所小学名称是？ 答案：实验小学
5. 点击"保存密保问题"
6. 看到"密保问题设置成功！"提示

### 步骤 5：测试密保问题找回密码

1. 退出登录
2. 在登录页面点击"忘记密码？"
3. 切换到"密保问题找回"标签
4. 输入用户名，点击"获取密保问题"
5. 看到3个密保问题显示出来
6. 依次回答3个密保问题
7. 输入新密码和确认密码
8. 点击"重置密码"
9. 看到"密码重置成功！请重新登录"提示
10. 使用新密码登录测试

## ⚠️ 注意事项

1. **数据库更新**：必须先执行 SQL 脚本添加字段，否则后端会报错
2. **密保答案安全**：
   - 答案使用 MD5 加密存储
   - 答案自动转为小写，不区分大小写
3. **必须设置3个问题**：系统要求用户设置完整的3个密保问题和答案
4. **找回条件**：只有设置了密保问题的用户才能使用密保问题找回密码
5. **兼容性**：密保问题找回和邮箱找回两种方式可以同时使用

## 🔐 安全说明

1. 密保答案使用 MD5 加密存储，不存储明文
2. 答案统一转为小写后加密，避免大小写问题
3. 获取密保问题接口不需要登录，但只返回问题不返回答案
4. 重置密码需要正确回答所有3个密保问题

## 📝 补充说明

### 如果邮件发送失败：

密保问题找回功能完全独立于邮件系统，即使邮件配置有问题，密保问题找回依然可以正常使用。这样用户有两种找回密码的方式：
1. 邮箱找回（需要邮件服务器配置）
2. 密保问题找回（不依赖邮件，只需数据库）

## 🎉 功能优势

相比纯邮箱找回，密保问题找回有以下优势：
- ✓ 不依赖邮件服务器
- ✓ 即时响应，无需等待邮件
- ✓ 更适合邮箱丢失或无法访问的情况
- ✓ 用户体验更流畅
- ✓ 服务器压力更小（不需要发送邮件）

