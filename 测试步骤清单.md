# 校园社区论坛系统 - 完整测试步骤

## 前置准备

### 1. 启动后端
```bash
cd D:\校园1\campus-community-system
mvn clean install
cd forum-starter
mvn spring-boot:run
```
✅ 等待看到 "Started CampusCommunitySystemApplication" 消息

### 2. 启动前端
```bash
cd D:\校园1\frontend
npm install
npm run serve
```
✅ 等待看到 "App running at: http://localhost:8081/"

### 3. 打开浏览器
- 访问：http://localhost:8081/
- 打开浏览器开发者工具（F12）
  - 切换到 Console 标签（查看前端日志）
  - 切换到 Network 标签（查看网络请求）

---

## 测试用例

### 测试1：用户注册
**步骤：**
1. 点击页面右上角的"注册"按钮
2. 填写注册表单：
   - 用户名：testuser001
   - 密码：123456
   - 确认密码：123456
   - 邮箱：testuser001@example.com
3. 点击"注册"按钮

**预期结果：**
- ✅ 弹出成功提示："注册成功！"
- ✅ 注册弹窗自动关闭
- ✅ Console 中显示注册请求和响应
- ✅ Network 中看到 `/api/user/register` 请求，状态码 200

---

### 测试2：用户登录
**步骤：**
1. 点击页面右上角的"登录"按钮
2. 填写登录表单：
   - 用户名：testuser001
   - 密码：123456
3. 点击"登录"按钮

**预期结果：**
- ✅ 弹出成功提示："登录成功！"
- ✅ 登录弹窗自动关闭
- ✅ 页面刷新后，右上角显示用户头像和用户名
- ✅ Console 中显示：
  ```
  Login response: {code: 200, ...}
  Login successful, user: {...}, token: xxx-xxx-xxx
  Vuex: User updated: {...}
  Vuex: Token updated: xxx-xxx-xxx
  ```
- ✅ Network 中看到 `/api/user/login` 请求，状态码 200
- ✅ 后端控制台显示：
  ```
  >>> Interceptor: GET /api/user/...
  >>> Authorization header: xxx-xxx-xxx
  >>> Found LoginTicket: ...
  >>> User loaded: testuser001
  ```

**检查存储：**
- 打开浏览器 Application/Storage 标签
- 查看 Local Storage → http://localhost:8081
- ✅ 应该看到 `user` 和 `token` 两个键

---

### 测试3：浏览首页帖子
**步骤：**
1. 登录成功后，停留在首页
2. 滚动查看帖子列表

**预期结果：**
- ✅ 看到帖子列表（如果数据库有数据）
- ✅ 每个帖子显示：标题、作者、发布时间、点赞数、评论数
- ✅ Network 中看到 `/api/post/list?userId=0` 请求

---

### 测试4：查看用户菜单
**步骤：**
1. 点击右上角的用户头像

**预期结果：**
- ✅ 下拉菜单展开
- ✅ 看到以下菜单项：
  - 个人主页
  - 消息中心（有消息数量徽章）
  - 编辑个人资料
  - 退出登录

---

### 测试5：编辑个人资料
**步骤：**
1. 点击"编辑个人资料"菜单项
2. 页面跳转到 `/profile/edit`
3. 测试头像上传：
   - 点击"选择本地图片"按钮
   - 选择一张本地图片（建议 < 2MB）
   - 查看预览是否正常显示
4. 测试默认头像：
   - 点击"使用默认头像"按钮
   - 查看是否切换到默认头像
5. 修改个人简介：
   - 在简介文本框输入："这是我的测试简介，测试用户001。"
6. 修改邮箱：
   - 输入新邮箱："newemail@example.com"
7. 点击"保存修改"按钮

**预期结果：**
- ✅ Console 中显示：
  ```
  Submitting form...
  Current user: {...}
  Current token: xxx-xxx-xxx
  Form data: {...}
  Submitting avatar...
  Avatar response: {code: 200, ...}
  Submitting introduction...
  Introduction response: {code: 200, ...}
  Submitting email...
  Email response: {code: 200, ...}
  ```
- ✅ 弹出成功提示："资料更新成功！"
- ✅ Network 中看到以下请求（全部状态码 200）：
  - PUT `/api/user/avatar`
  - PUT `/api/user/profile`
  - PUT `/api/user/email`
- ✅ 后端控制台显示：
  ```
  >>> Interceptor: PUT /api/user/avatar
  >>> Authorization header: xxx-xxx-xxx
  >>> User loaded: testuser001
  >>> updateAvatar called
  >>> currentUser: User{id=X, username='testuser001', ...}
  ```

**如果返回 403 错误：**
- ❌ 检查 Network 中的请求头是否包含 `Authorization: xxx-xxx-xxx`
- ❌ 检查后端控制台是否显示 `>>> currentUser is NULL!`
- ❌ 参考下面的"问题排查"部分

---

### 测试6：查看个人主页
**步骤：**
1. 点击用户菜单中的"个人主页"
2. 查看个人资料和帖子

**预期结果：**
- ✅ 显示用户头像、用户名、简介
- ✅ 显示用户统计：帖子数、粉丝数、关注数
- ✅ 显示三个标签页：我的帖子、我的收藏、我的评论
- ✅ "我的帖子"标签页只显示当前用户发布的帖子
- ✅ Network 中看到 `/api/post/list?userId=X`（X 是当前用户 ID）

---

### 测试7：退出登录
**步骤：**
1. 点击用户菜单中的"退出登录"
2. 在确认对话框中点击"确定"

**预期结果：**
- ✅ 弹出确认对话框："确定要退出登录吗？"
- ✅ 点击确定后，弹出成功提示："已成功退出登录"
- ✅ 页面跳转回首页
- ✅ 右上角恢复显示"登录"和"注册"按钮
- ✅ Console 中显示：
  ```
  Vuex: User cleared
  Vuex: Token cleared
  ```
- ✅ Network 中看到 GET `/api/user/logout` 请求，状态码 200
- ✅ Local Storage 中的 `user` 和 `token` 被清空

---

## 问题排查

### 问题1：登录后没有显示用户头像
**排查步骤：**
1. 打开 Console，查找 "Login successful, user:" 日志
2. 检查 `user` 对象是否包含完整信息
3. 检查 Local Storage 中的 `user` 数据
4. 刷新页面（Ctrl+F5 强制刷新）

**可能原因：**
- 后端 `login` 接口没有返回 `user` 对象
- 前端没有正确保存 `user` 到 Local Storage

---

### 问题2：保存个人资料时返回 403 错误
**排查步骤：**
1. 打开 Network 标签
2. 找到失败的请求（红色显示）
3. 查看 Request Headers，确认是否包含 `Authorization` 字段
4. 打开后端控制台，查找以下日志：
   ```
   >>> Interceptor: PUT /api/user/...
   >>> Authorization header: (应该有值)
   >>> User loaded: (应该有用户名)
   ```

**可能原因：**
- Token 没有被正确发送到后端
- 后端拦截器没有正确解析 Token
- 后端 `HostHolder` 中的用户为 null

**解决方案：**
1. 确认 `WebMvcConfig.java` 中 CORS 配置包含 `http://localhost:8081`
2. 确认 `LoginTicketInterceptor.java` 中优先检查 `Authorization` header
3. 确认 `SecurityConfig.java` 中相关路径需要认证
4. 重新编译后端：`mvn clean install`
5. 重启后端服务
6. 清除浏览器缓存，重新登录

---

### 问题3：所有帖子都显示为"我的帖子"
**排查步骤：**
1. 在首页，打开 Network 标签
2. 查看 `/api/post/list` 请求的 Query Parameters
3. 应该是 `userId=0`（表示所有用户）

**可能原因：**
- `PostList.vue` 组件没有正确处理 `userId` prop

**解决方案：**
- 确认 `PostList.vue` 中 `fetchPosts` 方法的逻辑：
  ```javascript
  const params = {};
  if (this.userId) {
    params.userId = this.userId;
  } else {
    params.userId = 0; // 0 表示所有用户
  }
  ```

---

### 问题4：后端报错 "IllegalStateException: Cannot call sendError()"
**排查步骤：**
1. 查看后端控制台完整的堆栈跟踪
2. 确认是哪个拦截器或过滤器抛出的异常

**可能原因：**
- 响应已经被提交后，又尝试发送错误响应
- 可能是 Spring Security 的过滤器链出现问题

**解决方案：**
- 检查 `LoginTicketInterceptor` 的 `preHandle` 方法
- 确保在所有情况下都正确返回 `true` 或 `false`
- 不要在响应已提交后再修改响应

---

## 测试检查清单

### 功能测试
- [ ] 用户注册成功
- [ ] 用户登录成功，显示头像
- [ ] 浏览首页帖子列表
- [ ] 打开用户下拉菜单
- [ ] 编辑个人资料（头像、简介、邮箱）全部成功
- [ ] 查看个人主页，只显示自己的帖子
- [ ] 退出登录成功，清除登录状态

### 数据验证
- [ ] Local Storage 中正确存储 user 和 token
- [ ] 所有 API 请求都携带 Authorization header
- [ ] 后端拦截器正确解析 token 并加载用户

### UI/UX 测试
- [ ] 登录后头像正确显示
- [ ] 用户名正确显示
- [ ] 下拉菜单样式正常
- [ ] 个人资料编辑页面布局正常
- [ ] 头像预览正常
- [ ] 所有提示信息正确显示

### 错误处理
- [ ] 登录失败提示正确
- [ ] 保存失败提示正确
- [ ] 退出登录确认对话框正常
- [ ] 网络错误提示正确

---

## 测试完成标准

当以上所有测试用例都通过（✅），并且：
1. **没有 403 错误**
2. **后端控制台正确显示用户信息**
3. **前端 Console 没有错误**
4. **Network 中所有请求状态码都是 200**
5. **所有功能正常工作**

那么测试就算完成了！

---

## 快速测试命令

如果你想快速重新开始测试，可以按顺序执行：

```bash
# 终端1：启动后端
cd D:\校园1\campus-community-system
mvn clean install && cd forum-starter && mvn spring-boot:run

# 终端2：启动前端
cd D:\校园1\frontend
npm run serve
```

然后在浏览器访问 http://localhost:8081/，按照上面的测试用例逐一测试。

---

**祝测试顺利！** 🎉

