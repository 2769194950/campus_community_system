<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campus.forum.dal.mapper.PostMapper">

    <resultMap id="PostWithUser" type="com.campus.forum.dal.domain.Post">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="partitionId" column="partition_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="type" column="type"/>
        <result property="status" column="status"/>
        <result property="viewCount" column="view_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="score" column="score"/>
        <result property="createTime" column="create_time"/>
        <association property="user" javaType="com.campus.forum.dal.domain.User">
            <id property="id" column="u_id"/>
            <result property="username" column="username"/>
            <result property="avatarUrl" column="avatar_url"/>
        </association>
    </resultMap>

    <sql id="selectFields">
        id, user_id, partition_id, title, content, type, status, view_count, comment_count, like_count, favorite_count, score, create_time
    </sql>

    <sql id="insertFields">
        user_id, partition_id, title, content, type, status, view_count, comment_count, like_count, favorite_count, score, create_time
    </sql>

    <select id="selectPosts" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        <if test="userId != 0">
            and p.user_id = #{userId}
        </if>
        <if test="partitionId != null">
            and p.partition_id = #{partitionId}
        </if>
        order by p.type desc, p.create_time desc
    </select>

    <select id="selectLatestPosts" resultMap="PostWithUser">
        SELECT p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.status != 2
        ORDER BY p.create_time DESC
        LIMIT #{limit}
    </select>
    
    <select id="selectPostById" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.id = #{id}
    </select>

    <insert id="insertPost" parameterType="com.campus.forum.dal.domain.Post" keyProperty="id" useGeneratedKeys="true">
        insert into post(<include refid="insertFields"></include>)
        values(#{userId}, #{partitionId}, #{title}, #{content}, #{type}, #{status}, #{viewCount}, #{commentCount}, #{likeCount}, #{favoriteCount}, #{score}, #{createTime})
    </insert>

    <update id="updateCommentCount">
        update post set comment_count = #{commentCount} where id = #{id}
    </update>
    
    <update id="updateFavoriteCount">
        update post set favorite_count = #{favoriteCount} where id = #{id}
    </update>
    
    <update id="updateStatus">
        update post set status = #{status} where id = #{id}
    </update>
    <update id="updateLikeCount">
        update post set like_count = #{likeCount} where id=#{id}
    </update>

    <select id="selectHotPosts" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        order by (p.like_count + p.comment_count + p.favorite_count) desc, p.create_time desc
        limit #{limit}
    </select>

    <update id="incrementLikeCount">
        update post set like_count = like_count + 1 where id = #{id}
    </update>

    <update id="decrementLikeCount">
        update post set like_count = like_count - 1 where id = #{id} and like_count > 0
    </update>
    <update id="updateViewCount">
        update post set view_count = #{viewCount} where id = #{id}
    </update>
    <update id="incrementViewCount">
        update post set view_count = view_count + 1 where id = #{id}
    </update>
    <update id="incrementCommentCount">
        update post set comment_count = comment_count + 1 where id = #{id}
    </update>
    <update id="decrementCommentCount">
        update post set comment_count = comment_count - 1 where id = #{id}

    </update>


    <select id="selectPostsByKeyword" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        and (p.title like concat('%', #{keyword}, '%') or p.content like concat('%', #{keyword}, '%'))
        order by p.create_time desc
    </select>
    
    <select id="selectAllPosts" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        order by p.create_time desc
        limit #{offset}, #{limit}
    </select>

    <select id="selectViewCount" resultType="java.lang.Integer">
        select view_count from post where id = #{id}
    </select>
    <select id="selectByIds" resultMap="PostWithUser">
        SELECT p.*, u.id as u_id, u.username, u.avatar_url
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY p.create_time DESC
    </select>

    <select id="countPosts" resultType="int">
        select count(*) from post where status != 2
    </select>

    <!-- 根据时间周期获取热门帖子 -->
    <select id="selectHotPostsByPeriod" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        <if test="period == 'daily'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        </if>
        <if test="period == 'weekly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
        </if>
        <if test="period == 'monthly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        </if>
        order by (p.like_count + p.comment_count + p.favorite_count) desc, p.create_time desc
        limit #{limit}
    </select>

    <!-- 根据收藏数排序获取帖子 -->
    <select id="selectPostsByFavorites" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        <if test="period == 'daily'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        </if>
        <if test="period == 'weekly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
        </if>
        <if test="period == 'monthly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        </if>
        <if test="period == 'latest'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        </if>
        order by p.favorite_count desc, p.create_time desc
        limit #{limit}
    </select>

    <!-- 根据点赞数排序获取帖子 -->
    <select id="selectPostsByLikes" resultMap="PostWithUser">
        select p.id, p.user_id, p.partition_id, p.title, p.content, p.type, p.status, 
               p.view_count, p.comment_count, p.like_count, p.favorite_count, p.score, p.create_time,
               u.id as u_id, u.username, u.avatar_url
        from post p
        left join user u on p.user_id = u.id
        where p.status != 2
        <if test="period == 'daily'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        </if>
        <if test="period == 'weekly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 WEEK)
        </if>
        <if test="period == 'monthly'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        </if>
        <if test="period == 'latest'">
            AND p.create_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        </if>
        order by p.like_count desc, p.create_time desc
        limit #{limit}
    </select>
</mapper>
